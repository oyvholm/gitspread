#!/bin/bash

#=======================================================================
# gitspreadd
# File ID: 9277e412-5ebe-11e0-ae13-fefdb24f8e10
# Push received commits and tags to other remotes to save bandwith
# License: GNU General Public License version 3 or later.
#=======================================================================

progname=gitspreadd
spool=$HOME/Git-spread/spool
repo=$HOME/Git-spread
logfile=$repo/$progname.log

log() {
    echo "$(date -u +"%Y-%m-%dT%H:%M:%SZ -") $*" >>$logfile
}

log Starting $progname
while :; do
    if [ -e $spool/* ]; then
        log $progname: Found new commits: $(cd $spool; ls)
        cd $spool || { log $progname: $spool: Cannot chdir, aborting; exit 1; }
        for f in *; do
            log $progname: Processing $f
            cd $repo/$f.git || { log $progname: $repo/$f.git: Cannot chdir, aborting >&2; exit 1; }
            for r in $(git remote); do
                git push --all $r >>$logfile 2>&1
                git push --tags $r >>$logfile 2>&1
            done
            rm -v $spool/$f >>$logfile 2>&1
        done
    fi
    sleep 5
done
